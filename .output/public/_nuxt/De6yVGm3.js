import{r as d,y as le,G as q,g as Pe,A as Le,c as m,a as s,b as I,h as Ue,d as A,F as H,k as ie,w as x,I as Q,o as y,n as Te,q as g,j as b,t as w,i as W,m as X,l as re}from"./qcAyaCsh.js";import{P as Fe}from"./BwqIjmm3.js";import{_ as ne}from"./Bf31Cja4.js";import{l as Y,f as ee,s as Ve,a as ze,b as Oe,c as Me,r as je,d as $e,e as Ge,g as de}from"./3xuymguz.js";import{f as Re,s as Ke}from"./BA3JyHsk.js";import{isApiEnabled as te}from"./BH6je_ft.js";import{u as qe}from"./BSU2ZXQ6.js";import{fetchUsersApi as Qe}from"./BVG6iaWI.js";import"./CGbtcE1L.js";import"./BlnrnVG4.js";import"./CV9EyYCX.js";const Be={class:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"},Je={class:"px-6 py-5 space-y-6"},Ze={class:"rounded-xl border border-slate-800 bg-slate-900/80 px-5 py-5","aria-labelledby":"pipeline-list-header"},He={class:"p-2"},We={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"},Xe=["onClick"],Ye=["onClick"],et={class:"mt-5 space-y-3"},tt={class:"flex items-center justify-between"},st={class:"text-sm font-semibold text-white truncate"},at=["onClick","title"],ot={class:"flex items-center justify-between text-xs"},lt={class:"flex items-center gap-2"},it={class:"flex items-center gap-2"},rt=["onClick"],nt={class:"space-y-4"},dt={class:"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3"},ct=["onClick"],ut={class:"w-9 h-9 rounded-lg bg-slate-900/70 flex items-center justify-center text-base"},pt={class:"flex-1"},ft={class:"text-sm font-semibold text-slate-100"},vt={class:"text-[11px] text-slate-400"},mt={key:0,class:"fa-solid fa-circle-check text-indigo-400"},xt={class:"flex items-center justify-end gap-2"},yt=["disabled"],gt={key:0,class:"fa-solid fa-spinner fa-spin text-xs"},bt={class:"space-y-3 max-h-[70vh] overflow-y-auto pr-1"},wt={class:"space-y-2"},ht={class:"rounded-md border border-slate-700/60 bg-slate-900/40 px-3 py-2"},Ct={class:"text-white text-sm font-semibold"},kt={class:"text-[11px] text-slate-400"},It=["placeholder"],At={key:0,class:"text-[11px] text-red-400 mt-1"},_t={class:"flex items-center justify-end gap-2"},Dt=["disabled"],jt={__name:"pipeline",setup(Nt){const{setLastKey:h}=qe(),{success:B,error:M,info:ce}=Le(),r=d(Y()),l=d(r.value[0]?.key||""),_=d(""),D=d("GENERIC"),N=d(!1),F=d(!1),V=d([]),C=d([]),f=d([]),ue=[{value:"GENERIC",label:"Pipeline Livre",description:"Fluxo flexível para diferentes contextos.",icon:"fa-solid fa-diagram-project text-slate-300"},{value:"FINANCIAL",label:"Financeiro",description:"Controle de etapas com indicadores financeiros.",icon:"fa-solid fa-dollar-sign text-emerald-400"},{value:"TODO_LIST",label:"To-do List",description:"Gestão de tarefas e checklists colaborativos.",icon:"fa-solid fa-list-check text-sky-400"},{value:"LEAD_QUALIFICATION",label:"Qualificação de Leads",description:"Integração direta com o cadastro de leads.",icon:"fa-solid fa-user-check text-indigo-400"}],j={GENERIC:"Pipeline Livre",FINANCIAL:"Financeiro",TODO_LIST:"To-do List",LEAD_QUALIFICATION:"Qualificação de Leads"},pe=le(()=>{const a=new Map;for(const e of V.value||[])e?.id&&a.set(String(e.id),e);return a});function E(a){return Array.from(new Set((a||[]).filter(e=>typeof e=="string").map(e=>e.trim()).filter(Boolean)))}function fe(a,e){const t=typeof a=="string"?a.trim().toUpperCase():void 0;return t?j[t]||j.GENERIC:e?j.FINANCIAL:j.GENERIC}function ve(a,e){const t=typeof a=="string"?a.trim().toUpperCase():void 0;return t==="FINANCIAL"||t==null&&e?"fa-coins text-emerald-300":t==="TODO_LIST"?"fa-list-check text-sky-300":t==="LEAD_QUALIFICATION"?"fa-user-check text-indigo-300":"fa-diagram-project text-slate-300"}function me(a,e){const t=typeof a=="string"?a.trim().toUpperCase():void 0;return t==="FINANCIAL"||t==null&&e?"bg-emerald-500/10 text-emerald-300 border border-emerald-500/40":t==="TODO_LIST"?"bg-sky-500/10 text-sky-300 border border-sky-500/30":t==="LEAD_QUALIFICATION"?"bg-indigo-500/10 text-indigo-300 border border-indigo-500/30":"bg-slate-800 text-slate-400 border border-slate-700"}function $(){const a=r.value.find(e=>e.key===l.value);f.value=E(a?.allowedUserIds||[])}q(l,()=>{$()}),q(V,()=>{const a=new Set(pe.value.keys()),e=t=>E((t||[]).filter(o=>!a.size||a.has(o)));C.value=e(C.value),f.value=e(f.value)}),q(r,()=>{$()});async function xe(){const a=_.value.trim();if(!a)return;const e=globalThis.crypto?.randomUUID?.()||Math.random().toString(36).slice(2)+Date.now().toString(36);if(N.value)return;N.value=!0;const t=D.value,o=z[t]?[...z[t]]:[],u=E(C.value);if(r.value=[...r.value,{key:e,name:a,active:!0,type:t,isFinanceiro:t==="FINANCIAL",allowedUserIds:u}],await ze(e,a||e,t,u)){if(o.length)try{await Oe(e,o),c.value=[...o]}catch(i){console.error("Falha ao registrar blueprint do processo:",i)}l.value=e,h(e),_.value="",D.value="GENERIC",C.value=[],f.value=E(u),B("Processo criado"),F.value=!1}else r.value=r.value.filter(i=>i.key!==e),M("Falha ao criar processo. Tente novamente.");N.value=!1}function se(){_.value="",D.value="GENERIC",C.value=[],F.value=!0}function ye(){F.value=!1}const z={GENERIC:[{id:"briefing",title:"Briefing Inicial",slaDays:2,color:"sky"},{id:"execucao",title:"Execução",slaDays:5,color:"violet"},{id:"revisao",title:"Revisão",slaDays:3,color:"amber"}],FINANCIAL:[{id:"entrada",title:"Entrada de Dados",slaDays:2,color:"emerald"},{id:"analise_credito",title:"Análise de Crédito",slaDays:3,color:"cyan"},{id:"formalizacao",title:"Formalização",slaDays:4,color:"indigo"}],TODO_LIST:[{id:"planejamento",title:"Planejamento",slaDays:1,color:"pink"},{id:"execucao_tarefas",title:"Execução de Tarefas",slaDays:5,color:"purple"},{id:"validacao",title:"Validação",slaDays:2,color:"lime"}],LEAD_QUALIFICATION:[{id:"captacao",title:"Captação",slaDays:1,color:"blue",defaultStatus:"Novo Lead"},{id:"contato",title:"Contato Inicial",slaDays:2,color:"emerald",defaultStatus:"Contato Realizado"},{id:"qualificacao",title:"Qualificação",slaDays:3,color:"violet",defaultStatus:"Qualificado"},{id:"negociacao",title:"Negociação",slaDays:2,color:"amber",defaultStatus:"Em Negociação"}]},c=d([...z.GENERIC]),S=d(""),P=d(!1);function ge(){P.value=!0}function be(){P.value=!1}async function we(){if(l.value){if(!te()){const o=Me(S.value||l.value),n=(i=>{const p=new Set(Y().map(U=>U.key));if(!p.has(i)||i===l.value)return i;let k=2;for(;p.has(`${i}-${k}`);)k++;return`${i}-${k}`})(o);if(n!==l.value){if(!je(l.value,n).ok)return;l.value=n,h(n)}}const a=S.value||l.value,e=E(f.value),t=await $e(l.value,{name:a,allowedUserIds:e});t&&(r.value=r.value.map(o=>o.key===l.value?{...o,name:a,allowedUserIds:e}:o));try{const o=(c.value||[]).map(n=>({id:n.id,title:n.title})),u=await Ge(l.value,o,c.value);if(Array.isArray(u)&&u.length){const n=u.map(i=>({id:i.id,title:i.title,slaDays:i.slaDays,color:i.color}));c.value=n;try{const i=`pipeline_stage_forms__${l.value}`,p=localStorage.getItem(i),k=p?JSON.parse(p)||{}:{},U={...k};for(let K=0;K<n.length;K++){const O=o[K]?.id,T=n[K]?.id;if(!(!O||!T||O===T)&&k[O]&&(U[T]=k[O],delete U[O],te()&&/^[a-fA-F0-9]{24}$/.test(T))){const Ee=(U[T]||[]).map((oe,Se)=>({...oe,order:Se}));try{await Ke(T,Ee)}catch{}}}localStorage.setItem(i,JSON.stringify(U))}catch{}}t?B("Esteira salva"):ce("Etapas salvas; falha ao atualizar dados do processo"),P.value=!1}catch{M("Falha ao salvar etapas. Verifique a conexão.");return}}else P.value=!1}Pe(async()=>{if(await ke(),$(),!l.value)return;const a=await ee(l.value);c.value=Array.isArray(a)?a.map(e=>({id:e.id,title:e.title,slaDays:e.slaDays,color:e.color})):[],await J()}),q(l,async a=>{if(!a){c.value=[];return}const e=await ee(a);c.value=Array.isArray(e)?e.map(o=>({id:o.id,title:o.title,slaDays:o.slaDays,color:o.color})):[],h(a);const t=r.value.find(o=>o.key===a);S.value=t?.name||a,await J()});function he(a){Ve(a.key,a.active===!1),r.value=Y()}async function Ce(a){l.value=a.key;const e=await ee(a.key);c.value=Array.isArray(e)?e.map(t=>({id:t.id,title:t.title,slaDays:t.slaDays,color:t.color})):[],!c.value.length&&a.type&&z[a.type]&&(c.value=[...z[a.type]]),h(a.key),S.value=a.name||a.key,f.value=E(a.allowedUserIds||[]),await J(),ge()}async function J(){if(te())try{const a=`pipeline_stage_forms__${l.value}`,e=localStorage.getItem(a),o={...e?JSON.parse(e)||{}:{}};for(const u of c.value||[]){const n=u?.id;if(!(!n||!/^[a-fA-F0-9]{24}$/.test(n)))try{const i=await Re(n);Array.isArray(i)&&(o[n]=i.map(p=>({id:p.id||String(Date.now()),label:p.label,type:p.type,required:!!p.required,placeholder:p.placeholder||"",options:Array.isArray(p.options)?p.options:[]})))}catch{}}localStorage.setItem(a,JSON.stringify(o))}catch{}}async function ke(){try{V.value=await Qe()}catch(a){console.error("Failed to load users list:",a),M("Erro ao carregar usuários");return}$()}const G=d(!1),v=d(null),L=d(""),Z=le(()=>{const a=(v.value?.name||"").trim().toLowerCase(),e=L.value.trim().toLowerCase();return!!a&&e===a}),R=d(!1);function Ie(a){v.value=a,L.value="",G.value=!0}function ae(){G.value=!1,v.value=null,L.value=""}async function Ae(){const a=v.value;if(!a||!Z.value)return;const e=a.key;r.value=r.value.filter(o=>o.key!==e),l.value===e&&(l.value=r.value[0]?.key||"",c.value=[],l.value&&h(l.value)),await de(e)?B("Processo excluído"):(r.value=[...r.value,a],M("Falha ao excluir. Tente novamente.")),ae()}function _e(a){if((a.ctrlKey||a.metaKey)&&a.key.toLowerCase()==="v"){a.preventDefault();return}}function De(){R.value=!1}function Ne(){try{r.value.map(e=>e.key).forEach(e=>de(e)),localStorage.removeItem("pipeline_processes")}catch{}r.value=[],l.value="",c.value=[],h(""),R.value=!1}return l.value&&h(l.value),(a,e)=>(y(),m("div",Be,[s("header",{class:"app-header bg-slate-900 border-b border-slate-800/70 px-6 py-4"},[s("div",{class:"flex items-center justify-between gap-4"},[e[17]||(e[17]=Ue('<div class="flex items-center gap-4"><div class="flex h-11 w-11 items-center justify-center rounded-lg bg-slate-800 text-slate-200"><i class="fa-solid fa-sitemap"></i></div><div><h1 class="app-header-title">Configuração da Esteira</h1><p class="app-header-subtitle"> Cadastre processos e mantenha o fluxo operacional organizado </p></div></div>',1)),s("div",{class:"flex items-center gap-3"},[s("button",{class:"inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-200 transition hover:border-indigo-500 hover:text-white",onClick:se},[...e[15]||(e[15]=[s("i",{class:"fa-solid fa-plus text-xs"},null,-1),A(" Novo processo ",-1)])]),s("button",{class:"flex h-11 w-11 items-center justify-center rounded-lg border border-slate-700 bg-slate-900 text-slate-200 transition hover:border-indigo-500 hover:text-white",onClick:se,"aria-label":"Criar processo"},[...e[16]||(e[16]=[s("i",{class:"fa-solid fa-sitemap"},null,-1)])])])])]),s("main",Je,[e[21]||(e[21]=s("section",{class:"rounded-xl border border-slate-800 bg-slate-900/80 px-5 py-4"},[s("p",{class:"text-sm text-slate-400"},[A(" Utilize o botão "),s("span",{class:"text-slate-200"},"Novo processo"),A(" para registrar fluxos adicionais. Os processos existentes estão listados abaixo. ")])],-1)),s("section",Ze,[e[19]||(e[19]=s("div",{class:"flex items-center justify-between gap-3 flex-wrap mb-4"},[s("div",null,[s("h2",{id:"pipeline-list-header",class:"text-base font-semibold text-slate-100"}," Processos existentes "),s("p",{class:"text-sm text-slate-400"}," Selecione um processo para editar etapas e configurações ")])],-1)),s("div",He,[s("div",We,[(y(!0),m(H,null,ie(r.value,(t,o)=>(y(),m("div",{key:t.key,class:g(["group relative cursor-pointer overflow-hidden rounded-xl border border-slate-800/70 bg-slate-900/80 p-3 transition-all duration-300 hover:border-slate-700 hover:shadow-lg",t.key===l.value?"border-emerald-500/60 shadow-[0_0_25px_rgba(16,185,129,0.25)]":""]),style:Te({animationDelay:`${o*25}ms`}),onClick:u=>Ce(t)},[s("button",{class:"absolute top-1.5 left-1.5 text-[11px] px-2 py-0.5 rounded-full border border-slate-700 text-slate-400 uppercase tracking-wide",onClick:b(u=>l.value=t.key,["stop"])},w(t.key),9,Ye),s("div",et,[s("div",tt,[s("h3",st,w(t.name||"Processo"),1),s("button",{class:"rounded-md border border-slate-700 bg-slate-900 p-2 text-slate-200 hover:bg-slate-800",onClick:b(u=>he(t),["stop"]),title:t.active!==!1?"Desativar":"Ativar"},[s("i",{class:g(t.active!==!1?"fa-solid fa-power-off text-emerald-300":"fa-solid fa-play text-slate-400")},null,2)],8,at)]),s("div",ot,[s("div",lt,[s("span",{class:g(["inline-flex items-center gap-2 rounded-full px-2 py-0.5 text-xs",me(t.type,t.isFinanceiro)])},[s("i",{class:g(["fa-solid",ve(t.type,t.isFinanceiro)])},null,2),A(" "+w(fe(t.type,t.isFinanceiro)),1)],2),s("span",{class:g(["inline-flex items-center gap-1",t.active!==!1?"text-emerald-300":"text-slate-400"])},[s("span",{class:g(["inline-block w-2 h-2 rounded-full",t.active!==!1?"bg-emerald-400":"bg-slate-500"])},null,2),A(" "+w(t.active!==!1?"Ativo":"Inativo"),1)],2)]),s("div",it,[s("button",{class:"rounded-md border border-slate-700 bg-slate-900 p-2 text-red-300 hover:bg-slate-800",onClick:b(u=>Ie(t),["stop"]),title:"Excluir"},[...e[18]||(e[18]=[s("i",{class:"fa-regular fa-trash-can"},null,-1)])],8,rt)])])])],14,Xe))),128))])]),e[20]||(e[20]=s("div",{class:"mt-4 rounded-lg border border-slate-800 bg-slate-900 px-4 py-3"},[s("p",{class:"text-sm text-slate-400"},[s("i",{class:"fa-solid fa-info-circle text-slate-500 mr-2"}),A(" Selecione um processo para ajustar etapas, campos e automações. ")])],-1))])]),I(Q,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=t=>F.value=t),title:"Novo processo",size:"sm"},{footer:x(()=>[s("div",xt,[s("button",{class:"rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-300 hover:bg-slate-800",onClick:ye}," Cancelar "),s("button",{class:"inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-indigo-500 disabled:opacity-60",disabled:N.value||!_.value.trim(),onClick:xe},[N.value?(y(),m("i",gt)):(y(),m(H,{key:1},[e[24]||(e[24]=s("i",{class:"fa-solid fa-plus text-xs"},null,-1)),e[25]||(e[25]=A(" Criar processo ",-1))],64))],8,yt)])]),default:x(()=>[s("div",nt,[s("div",null,[e[22]||(e[22]=s("label",{class:"text-xs font-semibold text-slate-300 uppercase tracking-wide",for:"modal-pipeline-name"}," Nome do processo ",-1)),W(s("input",{id:"modal-pipeline-name","onUpdate:modelValue":e[0]||(e[0]=t=>_.value=t),class:"mt-2 w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none",placeholder:"ex.: ConsorEquity"},null,512),[[X,_.value]])]),s("div",null,[e[23]||(e[23]=s("label",{class:"text-xs font-semibold text-slate-300 uppercase tracking-wide"}," Tipo do processo ",-1)),s("div",dt,[(y(),m(H,null,ie(ue,t=>s("button",{key:t.value,type:"button",onClick:o=>D.value=t.value,class:g(["flex items-start gap-3 rounded-xl border px-3 py-3 text-left transition-all",D.value===t.value?"border-indigo-500 bg-indigo-500/10 shadow-lg shadow-indigo-500/20":"border-slate-700/60 bg-slate-900/40 hover:border-indigo-500/40"])},[s("div",ut,[s("i",{class:g(t.icon)},null,2)]),s("div",pt,[s("p",ft,w(t.label),1),s("p",vt,w(t.description),1)]),D.value===t.value?(y(),m("i",mt)):re("",!0)],10,ct)),64))])]),s("div",null,[I(ne,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=t=>C.value=t),users:V.value,label:"Usuários autorizados",description:"Deixe vazio para liberar o acesso a todos.","button-text":"Gerenciar acesso",disabled:N.value},null,8,["modelValue","users","disabled"])])])]),_:1},8,["modelValue"]),I(Q,{modelValue:P.value,"onUpdate:modelValue":e[6]||(e[6]=t=>P.value=t),title:"Gestão da Esteira",size:"lg","z-index":55},{footer:x(()=>[s("div",{class:"flex items-center justify-end gap-2"},[s("button",{class:"bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md text-sm",onClick:be}," Fechar "),s("button",{class:"bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-white px-3 py-2 rounded-md text-sm",onClick:we}," Salvar ")])]),default:x(()=>[s("div",bt,[s("div",null,[e[26]||(e[26]=s("label",{class:"text-[12px] text-slate-300"},"Nome do Processo",-1)),W(s("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>S.value=t),class:"mt-1 w-full bg-slate-800/70 border border-slate-700/60 text-slate-200 rounded-md px-3 py-2 text-sm",placeholder:"ex.: ConsorEquity"},null,512),[[X,S.value]])]),s("div",null,[I(ne,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=t=>f.value=t),users:V.value,label:"Usuários com acesso à esteira",description:"Sem seleção, todos os usuários com acesso ao sistema enxergam esta esteira.","button-text":"Gerenciar acesso"},null,8,["modelValue","users"])]),I(Fe,{stages:c.value,"onUpdate:stages":e[5]||(e[5]=t=>c.value=t),"pipeline-key":l.value},null,8,["stages","pipeline-key"])])]),_:1},8,["modelValue"]),I(Q,{modelValue:G.value,"onUpdate:modelValue":e[13]||(e[13]=t=>G.value=t),title:"Confirmar exclusão",size:"sm","z-index":60},{footer:x(()=>[s("div",_t,[s("button",{class:"bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md text-sm",onClick:ae}," Cancelar "),s("button",{class:"bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm",disabled:!Z.value,onClick:Ae}," Excluir Processo ",8,Dt)])]),default:x(()=>[s("div",wt,[e[28]||(e[28]=s("p",{class:"text-sm text-slate-200"}," Para confirmar, digite exatamente o nome do processo abaixo. ",-1)),s("div",ht,[s("div",Ct,w(v.value?.name||v.value?.key),1),s("div",kt,w(v.value?.key),1)]),s("div",null,[e[27]||(e[27]=s("label",{class:"text-[12px] text-slate-300"},"Digite o nome do processo",-1)),W(s("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>L.value=t),class:"mt-1 w-full bg-slate-800/70 border border-slate-700/60 text-slate-200 rounded-md px-3 py-2 text-sm",placeholder:v.value?.name||"",autocomplete:"off",autocapitalize:"off",spellcheck:"false",onPaste:e[8]||(e[8]=b(()=>{},["prevent"])),onDrop:e[9]||(e[9]=b(()=>{},["prevent"])),onCopy:e[10]||(e[10]=b(()=>{},["prevent"])),onCut:e[11]||(e[11]=b(()=>{},["prevent"])),onContextmenu:e[12]||(e[12]=b(()=>{},["prevent"])),onKeydown:_e},null,40,It),[[X,L.value]]),L.value&&!Z.value?(y(),m("div",At," O nome digitado não confere. ")):re("",!0)])])]),_:1},8,["modelValue"]),I(Q,{modelValue:R.value,"onUpdate:modelValue":e[14]||(e[14]=t=>R.value=t),title:"Confirmar reset",size:"sm","z-index":60},{footer:x(()=>[s("div",{class:"flex items-center justify-end gap-2"},[s("button",{class:"bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-md text-sm",onClick:De}," Cancelar "),s("button",{class:"bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm",onClick:Ne}," Zerar Dados ")])]),default:x(()=>[e[29]||(e[29]=s("div",{class:"space-y-2"},[s("p",{class:"text-sm text-slate-200"}," Tem certeza que deseja zerar todos os dados locais? "),s("p",{class:"text-[12px] text-slate-400"}," Esta ação removerá todos os processos e configurações locais. ")],-1))]),_:1},8,["modelValue"])]))}};export{jt as default};
