import{s as l}from"./BWJBdaIx.js";import{isApiEnabled as u,apiFetch as h}from"./Dbx-Jqc8.js";const i="pipeline_processes",_=s=>`pipeline_config__${s}`,y=s=>`pipeline_stage_forms__${s}`;function m(s,e){try{return s?JSON.parse(s):e}catch{return e}}let a=[],g=null,k=0;async function N(){if(!u())return;const s=Date.now();if(g)return g;if(!(s-k<800&&a.length))return g=h("/api/v1/processes").then(e=>{a=(e||[]).map(t=>({...t,active:t.active!==!1})),k=Date.now();try{localStorage.setItem(i,JSON.stringify(a))}catch{}}).catch(()=>{}).finally(()=>{g=null}),g}function d(){if(u())try{const e=a.length?a:typeof localStorage<"u"?m(localStorage.getItem(i),[]):[];return N(),(e||[]).map(t=>({...t,active:t.active!==!1}))}catch{return[]}return typeof localStorage>"u"?[]:m(localStorage.getItem(i),[]).map(e=>({...e,active:e.active!==!1}))}async function D(s,e){if(!s)return;if(u())try{await h("/api/v1/processes",{method:"POST",body:{key:s,name:e}}),a=[...a.filter(o=>o.key!==s),{key:s,name:e,active:!0}];try{localStorage.setItem(i,JSON.stringify(a))}catch{}try{window.dispatchEvent(new Event("processes:changed"))}catch{}return!0}catch{return!1}if(typeof localStorage>"u")return;const t=d(),n=l(s);if(n){if(!t.find(o=>o.key===n)){t.push({key:n,name:e||n,active:!0}),localStorage.setItem(i,JSON.stringify(t));try{window.dispatchEvent(new Event("processes:changed"))}catch{}}return!0}}async function K(s,e={}){const t=l(s);let n=null;e.backup!==!1&&(n=b(t));const o={success:!1,backup:n||void 0,deletedKeys:[]};if(u())try{await h(`/api/v1/processes/${encodeURIComponent(t)}`,{method:"DELETE"}),a=a.filter(c=>c.key!==t);try{localStorage.setItem(i,JSON.stringify(a))}catch{}o.deletedKeys=E(t);try{window.dispatchEvent(new Event("processes:changed"))}catch{}return o.success=!0,o}catch{return o}if(typeof localStorage>"u")return o;const r=d().filter(c=>c.key!==t);localStorage.setItem(i,JSON.stringify(r)),o.deletedKeys=E(t);try{window.dispatchEvent(new Event("processes:changed"))}catch{}return o.success=!0,o}function E(s){const e=l(s),t=[];if(typeof localStorage>"u")return t;const n=[_(e),y(e),`pipeline_proposals__${e}`],o=[`pipeline_files__${e}`,`pipeline_history__${e}`,`pipeline_analytics__${e}`,`pipeline_cache__${e}`,`pipeline_settings__${e}`,`pipeline_templates__${e}`,`pipeline_notifications__${e}`,`pipeline_reports__${e}`,`pipeline_exports__${e}`,`pipeline_backups__${e}`,`pipeline_workflow__${e}`,`pipeline_permissions__${e}`,`pipeline_logs__${e}`,`pipeline_drafts__${e}`];n.forEach(r=>{try{localStorage.getItem(r)!==null&&(localStorage.removeItem(r),t.push(r),console.info(`Deleted: ${r}`))}catch(c){console.warn(`Failed to delete ${r}:`,c)}}),o.forEach(r=>{try{localStorage.getItem(r)!==null&&(localStorage.removeItem(r),t.push(r))}catch{}});try{localStorage.getItem("pipeline_last_process")===e&&(localStorage.removeItem("pipeline_last_process"),t.push("pipeline_last_process"),console.info(`Cleared last_process reference: ${e}`))}catch{}try{Object.keys(localStorage).filter(p=>(p.includes(`__${e}`)||p.includes(`_${e}_`))&&!t.includes(p)).forEach(p=>{try{localStorage.removeItem(p),t.push(p),console.info(`Cleaned orphaned key: ${p}`)}catch{}}),t.length>0&&console.info(`Cascade deletion complete: removed ${t.length} keys for process "${e}"`,t)}catch(r){console.warn("Error during orphaned key cleanup:",r)}return t}function R(s,e){if(typeof localStorage>"u")return;const t=l(s),n=d().map(o=>o.key===t?{...o,active:e}:o);localStorage.setItem(i,JSON.stringify(n));try{window.dispatchEvent(new Event("processes:changed"))}catch{}}function j(){return d().filter(s=>s.active!==!1)}async function T(s,e){if(u())try{await h(`/api/v1/processes/${encodeURIComponent(l(s))}`,{method:"PUT",body:{name:e}}),a=a.map(o=>o.key===l(s)?{...o,name:e}:o);try{localStorage.setItem(i,JSON.stringify(a))}catch{}try{window.dispatchEvent(new Event("processes:changed"))}catch{}return!0}catch{return!1}if(typeof localStorage>"u")return;const t=l(s),n=d().map(o=>o.key===t?{...o,name:e||t}:o);localStorage.setItem(i,JSON.stringify(n));try{window.dispatchEvent(new Event("processes:changed"))}catch{}return!0}function x(s,e){if(u())return{ok:!1,message:"not-supported"};if(typeof localStorage>"u")return{ok:!1,message:"no-storage"};const t=l(s),n=l(e);if(!n)return{ok:!1,message:"invalid-target"};if(t===n)return{ok:!0};const o=d(),r=o.findIndex(f=>f.key===t);if(r<0)return{ok:!1,message:"source-not-found"};if(o.some(f=>f.key===n))return{ok:!1,message:"target-exists"};const c=o.slice();c[r]={...c[r],key:n},localStorage.setItem(i,JSON.stringify(c));const p=_(t),$=_(n),S=y(t),O=y(n),v=`pipeline_proposals__${t}`,P=`pipeline_proposals__${n}`;try{const f=localStorage.getItem(p);f&&(localStorage.setItem($,f),localStorage.removeItem(p));const I=localStorage.getItem(S);I&&(localStorage.setItem(O,I),localStorage.removeItem(S));const w=localStorage.getItem(v);w&&(localStorage.setItem(P,w),localStorage.removeItem(v))}catch{}try{localStorage.setItem("pipeline_last_process",n)}catch{}try{window.dispatchEvent(new Event("processes:changed"))}catch{}return{ok:!0}}function F(s){if(typeof localStorage>"u")return[];const e=l(s);return m(localStorage.getItem(_(e)),[])}function A(s,e){if(typeof localStorage>"u")return;const t=l(s);localStorage.setItem(_(t),JSON.stringify(e||[]))}function b(s){if(typeof localStorage>"u")return null;const e=l(s),t={};return Object.keys(localStorage).filter(r=>r.includes(`__${e}`)||r.includes(`_${e}_`)).forEach(r=>{try{const c=localStorage.getItem(r);c&&(t[r]=JSON.parse(c))}catch{t[r]=localStorage.getItem(r)}}),Object.keys(t).length>0&&(t._metadata={processKey:e,backupDate:new Date().toISOString(),keyCount:Object.keys(t).length-1},console.info(`Backed up ${Object.keys(t).length-1} keys for process "${e}"`)),Object.keys(t).length>0?t:null}export{D as a,T as b,K as c,j as d,F as e,A as f,d as l,x as r,R as s};
