import{isApiEnabled as l,apiFetch as h}from"./BH6je_ft.js";import{u as R}from"./BlnrnVG4.js";async function I(t){if(!l())return[];try{return await h(`/api/v1/processes/${encodeURIComponent(t)}/stages`)}catch{return[]}}async function _(t,r){if(!l())return[];try{return await h(`/api/v1/processes/${encodeURIComponent(t)}/stages`,{method:"PUT",body:r||[]})}catch{return[]}}async function j(t,r){if(!l())return r;try{const e=await I(t),n=[...e,{title:r.title,slaDays:r.slaDays,color:r.color,defaultStatus:r.defaultStatus||"",order:e.length}],o=await _(t,n);return o[o.length-1]||null}catch(e){return console.error("Error creating stage:",e),null}}async function z(t,r,e){if(!l())return!1;try{const o=(await I(t)).map(s=>s.id===r?{id:s.id,title:e.title||s.title,slaDays:e.slaDays!==void 0?e.slaDays:s.slaDays,color:e.color||s.color,defaultStatus:e.defaultStatus!==void 0?e.defaultStatus:s.defaultStatus,order:e.order!==void 0?e.order:s.order}:s);return await _(t,o),!0}catch(n){return console.error("Error updating stage:",n),!1}}async function F(t,r){if(!l())return!1;try{const n=(await I(t)).filter(o=>o.id!==r).map((o,s)=>({...o,order:s}));return await _(t,n),!0}catch(e){return console.error("Error deleting stage:",e),!1}}async function b(t,r,e){if(!l())return e;try{const n=await I(t),o=e.map((s,a)=>{const c=s.id&&(s.id.startsWith("temp_")||s.id.match(/^\d+$/));let d=null;return!c&&s.id&&(d=n.find(i=>i.id===s.id)),d||(d=n.find(i=>i.title===s.title)),!d&&a<n.length&&(d=n[a]),{id:d?.id,title:s.title,slaDays:s.slaDays,color:s.color,defaultStatus:s.defaultStatus||d?.defaultStatus||"",order:a}});return await _(t,o)}catch(n){return console.error("Error preserving stage IDs:",n),await _(t,e)}}async function x(t,r){if(!l())return!1;try{const e=await I(t),n=new Map(r.map(s=>[s.id,s.order])),o=e.map(s=>({id:s.id,title:s.title,slaDays:s.slaDays,color:s.color,defaultStatus:s.defaultStatus,order:n.get(s.id)??0})).sort((s,a)=>s.order-a.order).map((s,a)=>({...s,order:a}));return await _(t,o),!0}catch{return!1}}const ee=Object.freeze(Object.defineProperty({__proto__:null,createStageApi:j,deleteStageApi:F,fetchStagesApi:I,saveStagesApi:_,saveStagesPreservingIdsApi:b,updateStageApi:z,updateStagesOrderApi:x},Symbol.toStringTag,{value:"Module"}));function f(t){return t?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g,"").replace(/[^a-z0-9_-]/g,""):""}const p="pipeline_processes",S=t=>`pipeline_config__${t}`,E=t=>`pipeline_stage_forms__${t}`;function k(t,r){try{return t?JSON.parse(t):r}catch{return r}}const D=R();if(typeof window<"u")try{D.load()}catch{}function g(t){if(!t)return{key:"",name:"",active:!0,type:"GENERIC",isFinanceiro:!1,allowedUserIds:[]};const r=typeof t.type=="string"?t.type.trim().toUpperCase():void 0,n=r&&["GENERIC","FINANCIAL","TODO_LIST","LEAD_QUALIFICATION"].includes(r)?r:t.isFinanceiro?"FINANCIAL":"GENERIC",o=t.allowedUserIds||t.allowedUsers||t.allowed_user_ids||[],s=Array.isArray(o)?Array.from(new Set(o.filter(c=>typeof c=="string").map(c=>c.trim()).filter(Boolean))):[];return{key:t.key||t.externalId||"",name:t.name||t.key||"",active:t.active!==!1,type:n,isFinanceiro:n==="FINANCIAL",allowedUserIds:s}}function J(t){const r=Array.isArray(t.allowedUserIds)?t.allowedUserIds.filter(n=>typeof n=="string"&&n.trim()):[];if(!r.length)return!0;const e=D.user.value;return e?.id?e.superUser?!0:r.includes(e.id):!1}function $(t){return Array.isArray(t)?Array.from(new Set(t.filter(e=>typeof e=="string").map(e=>e.trim()).filter(Boolean))):void 0}let u=[],w=null,P=0;async function L(){if(!l())return;const t=Date.now();if(w)return w;if(!(t-P<800&&u.length))return w=h("/api/v1/processes").then(r=>{u=(r||[]).map(e=>g(e)),P=Date.now();try{localStorage.setItem(p,JSON.stringify(u))}catch{}}).catch(()=>{}).finally(()=>{w=null}),w}function m(){if(l())try{const r=u.length?u:typeof localStorage<"u"?k(localStorage.getItem(p),[]):[];return L(),(r||[]).map(e=>g(e))}catch{return[]}return typeof localStorage>"u"?[]:k(localStorage.getItem(p),[]).map(r=>g(r))}async function G(t){if(!t)return null;if(l())try{const e=await h(`/api/v1/processes/${encodeURIComponent(t)}`);return g(e)}catch{return null}return m().find(e=>e.key===t)||null}async function M(t,r,e="GENERIC",n=[]){if(!t)return;if(l())try{const a=$(n)??[];await h("/api/v1/processes",{method:"POST",body:{key:t,name:r,type:e,allowedUserIds:a}}),u=[...u.filter(c=>c.key!==t),g({key:t,name:r,active:!0,type:e,allowedUserIds:a})];try{localStorage.setItem(p,JSON.stringify(u))}catch{}try{window.dispatchEvent(new Event("processes:changed"))}catch{}return!0}catch{return!1}if(typeof localStorage>"u")return;const o=m(),s=f(t);if(s){if(!o.find(a=>a.key===s)){const a=$(n)??[];o.push(g({key:s,name:r||s,active:!0,type:e,allowedUserIds:a})),localStorage.setItem(p,JSON.stringify(o));try{window.dispatchEvent(new Event("processes:changed"))}catch{}}return!0}}async function B(t,r){const e=f(t);if(!e||!Array.isArray(r)||!r.length)return;const n=r.map((o,s)=>({id:o.id||`stage_${s}_${Date.now()}`,title:o.title,slaDays:o.slaDays??0,color:o.color||"sky",defaultStatus:o.defaultStatus||""}));if(l()){try{await b(e,[],n)}catch(o){console.error("Falha ao aplicar blueprint via API:",o)}return}if(!(typeof localStorage>"u"))try{const o=S(e);localStorage.setItem(o,JSON.stringify(n))}catch(o){console.warn("Não foi possível persistir blueprint local:",o)}}async function K(t,r={}){const e=f(t);let n=null;r.backup!==!1&&(n=C(e));const o={success:!1,backup:n||void 0,deletedKeys:[]};if(l())try{await h(`/api/v1/processes/${encodeURIComponent(e)}`,{method:"DELETE"}),u=u.filter(a=>a.key!==e);try{localStorage.setItem(p,JSON.stringify(u))}catch{}o.deletedKeys=U(e);try{window.dispatchEvent(new Event("processes:changed"))}catch{}return o.success=!0,o}catch{return o}if(typeof localStorage>"u")return o;const s=m().filter(a=>a.key!==e);localStorage.setItem(p,JSON.stringify(s)),o.deletedKeys=U(e);try{window.dispatchEvent(new Event("processes:changed"))}catch{}return o.success=!0,o}function U(t){const r=f(t),e=[];if(typeof localStorage>"u")return e;const n=[S(r),E(r),`pipeline_proposals__${r}`],o=[`pipeline_files__${r}`,`pipeline_history__${r}`,`pipeline_analytics__${r}`,`pipeline_cache__${r}`,`pipeline_settings__${r}`,`pipeline_templates__${r}`,`pipeline_notifications__${r}`,`pipeline_reports__${r}`,`pipeline_exports__${r}`,`pipeline_backups__${r}`,`pipeline_workflow__${r}`,`pipeline_permissions__${r}`,`pipeline_logs__${r}`,`pipeline_drafts__${r}`];n.forEach(s=>{try{localStorage.getItem(s)!==null&&(localStorage.removeItem(s),e.push(s),console.info(`Deleted: ${s}`))}catch(a){console.warn(`Failed to delete ${s}:`,a)}}),o.forEach(s=>{try{localStorage.getItem(s)!==null&&(localStorage.removeItem(s),e.push(s))}catch{}});try{localStorage.getItem("pipeline_last_process")===r&&(localStorage.removeItem("pipeline_last_process"),e.push("pipeline_last_process"),console.info(`Cleared last_process reference: ${r}`))}catch{}try{Object.keys(localStorage).filter(c=>(c.includes(`__${r}`)||c.includes(`_${r}_`))&&!e.includes(c)).forEach(c=>{try{localStorage.removeItem(c),e.push(c),console.info(`Cleaned orphaned key: ${c}`)}catch{}}),e.length>0&&console.info(`Cascade deletion complete: removed ${e.length} keys for process "${r}"`,e)}catch(s){console.warn("Error during orphaned key cleanup:",s)}return e}function Y(t,r){if(typeof localStorage>"u")return;const e=f(t),n=m().map(o=>o.key===e?{...o,active:r}:o);localStorage.setItem(p,JSON.stringify(n));try{window.dispatchEvent(new Event("processes:changed"))}catch{}}function Q(){return m().filter(t=>t.active!==!1&&J(t))}async function W(t,r){if(!t)return!1;const e=typeof r=="string"?{name:r}:r||{},n=f(t),o=Object.prototype.hasOwnProperty.call(e,"allowedUserIds"),s=o?$(e.allowedUserIds)??[]:void 0,a=Object.prototype.hasOwnProperty.call(e,"name"),c={};if(a&&(c.name=e.name),o&&(c.allowedUserIds=s),l()){if(!Object.keys(c).length)return!0;try{await h(`/api/v1/processes/${encodeURIComponent(n)}`,{method:"PUT",body:c}),u=u.map(i=>{if(i.key!==n)return i;const v={...i,name:a?e.name||n:i.name,allowedUserIds:o?s:i.allowedUserIds};return g(v)});try{localStorage.setItem(p,JSON.stringify(u))}catch{}try{window.dispatchEvent(new Event("processes:changed"))}catch{}return!0}catch{return!1}}if(typeof localStorage>"u")return!1;const d=m().map(i=>{if(i.key!==n)return i;const v={...i,name:a?e.name||n:i.name,allowedUserIds:o?s:i.allowedUserIds};return g(v)});localStorage.setItem(p,JSON.stringify(d));try{window.dispatchEvent(new Event("processes:changed"))}catch{}return!0}function q(t,r){if(l())return{ok:!1,message:"not-supported"};if(typeof localStorage>"u")return{ok:!1,message:"no-storage"};const e=f(t),n=f(r);if(!n)return{ok:!1,message:"invalid-target"};if(e===n)return{ok:!0};const o=m(),s=o.findIndex(y=>y.key===e);if(s<0)return{ok:!1,message:"source-not-found"};if(o.some(y=>y.key===n))return{ok:!1,message:"target-exists"};const a=o.slice();a[s]={...a[s],key:n},localStorage.setItem(p,JSON.stringify(a));const c=S(e),d=S(n),i=E(e),v=E(n),A=`pipeline_proposals__${e}`,T=`pipeline_proposals__${n}`;try{const y=localStorage.getItem(c);y&&(localStorage.setItem(d,y),localStorage.removeItem(c));const O=localStorage.getItem(i);O&&(localStorage.setItem(v,O),localStorage.removeItem(i));const N=localStorage.getItem(A);N&&(localStorage.setItem(T,N),localStorage.removeItem(A))}catch{}try{localStorage.setItem("pipeline_last_process",n)}catch{}try{window.dispatchEvent(new Event("processes:changed"))}catch{}return{ok:!0}}function H(t){if(typeof localStorage>"u")return[];const r=f(t);return k(localStorage.getItem(S(r)),[])}function V(t,r){if(typeof localStorage>"u")return;const e=f(t);localStorage.setItem(S(e),JSON.stringify(r||[]))}function C(t){if(typeof localStorage>"u")return null;const r=f(t),e={};return Object.keys(localStorage).filter(s=>s.includes(`__${r}`)||s.includes(`_${r}_`)).forEach(s=>{try{const a=localStorage.getItem(s);a&&(e[s]=JSON.parse(a))}catch{e[s]=localStorage.getItem(s)}}),Object.keys(e).length>0&&(e._metadata={processKey:r,backupDate:new Date().toISOString(),keyCount:Object.keys(e).length-1},console.info(`Backed up ${Object.keys(e).length-1} keys for process "${r}"`)),Object.keys(e).length>0?e:null}const te=Object.freeze(Object.defineProperty({__proto__:null,addProcess:M,applyProcessBlueprint:B,backupProcessData:C,getProcessInfo:G,listActiveProcesses:Q,listProcesses:m,loadStages:H,removeProcess:K,renameProcessKey:q,sanitizeProcessKey:f,saveStages:V,setProcessActive:Y,setProcessName:W},Symbol.toStringTag,{value:"Module"}));export{M as a,B as b,f as c,W as d,b as e,I as f,K as g,Q as h,H as i,V as j,F as k,m as l,j as m,x as n,ee as o,te as p,q as r,Y as s,z as u};
