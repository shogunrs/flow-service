<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Font Awesome para ícones -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #1c1c1c;
        color: #d1d5db;
      }
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

      .form-input,
      .form-select,
      .form-textarea,
      .form-checkbox {
        background-color: #3e3e3e;
        color: #d1d5db;
        border-color: #4a4a4a;
      }
      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: #f97316;
        --tw-ring-color: #f97316;
      }
      .form-checkbox:checked {
        background-color: #f97316;
        border-color: #f97316;
      }
      .tab-active {
        border-color: #f97316;
        color: #f97316;
      }
      /* Estilos para transições suaves */
      .transition-all {
        transition: all 0.3s ease-in-out;
      }
      .max-h-0 {
        max-height: 0;
      }
      .max-h-screen {
        max-height: 100vh; /* ou um valor mais específico */
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 lg:p-8">
    <div id="admin-app" class="flex">
      <div class="flex-grow">
        <!-- Cabeçalho -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
          <div>
            <h1 class="text-3xl font-bold text-slate-100">Painel Administrativo</h1>
            <p class="text-slate-400 mt-1">
              Gerencie usuários, esteira e configurações da plataforma.
            </p>
          </div>
        </header>

        <!-- Abas de Navegação -->
        <div class="mb-6 border-b border-gray-700">
          <nav class="-mb-px flex space-x-6" aria-label="Tabs">
            <button
              @click="activeTab = 'users'"
              :class="activeTab === 'users' ? 'tab-active' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
            >
              Gerenciamento de Usuários
            </button>
            <button
              @click="activeTab = 'pipeline'"
              :class="activeTab === 'pipeline' ? 'tab-active' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
            >
              Configurações da Esteira
            </button>
            <button
              @click="activeTab = 'notifications'"
              :class="activeTab === 'notifications' ? 'tab-active' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'"
              class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
            >
              Notificações e Integrações
            </button>
          </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
          <!-- Gerenciamento de Usuários -->
          <div v-if="activeTab === 'users'">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold text-slate-200">Usuários da Plataforma</h2>
              <button
                @click="openUserModal()"
                class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-600 transition-colors flex items-center gap-2"
              >
                <i class="fa-solid fa-plus"></i> Novo Usuário
              </button>
            </div>
            <div class="bg-[#2D2D2D] rounded-lg overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-[#3E3E3E]/60 text-xs text-slate-300 uppercase">
                  <tr>
                    <th class="px-6 py-3">Nome</th>
                    <th class="px-6 py-3">Empresa</th>
                    <th class="px-6 py-3">Nível de Acesso</th>
                    <th class="px-6 py-3">Status</th>
                    <th class="px-6 py-3">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="user in users"
                    :key="user.id"
                    class="border-b border-[#3E3E3E] hover:bg-[#3E3E3E]/50"
                  >
                    <td class="px-6 py-4 font-medium text-slate-100">{{ user.name }}</td>
                    <td class="px-6 py-4 text-slate-300">{{ user.companyName }}</td>
                    <td class="px-6 py-4 text-slate-300">{{ user.accessLevel }}</td>
                    <td class="px-6 py-4">
                      <span
                        :class="user.isActive ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                        class="px-2 py-1 text-xs font-semibold rounded-full"
                        >{{ user.isActive ? 'Ativo' : 'Inativo' }}</span
                      >
                    </td>
                    <td class="px-6 py-4 flex items-center gap-4">
                      <button
                        @click="openUserModal(user)"
                        class="text-sky-400 hover:text-sky-300"
                        title="Editar"
                      >
                        <i class="fa-solid fa-pencil"></i>
                      </button>
                      <button class="text-red-500 hover:text-red-400" title="Desativar">
                        <i class="fa-solid fa-trash-can"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Configurações da Esteira -->
          <div v-if="activeTab === 'pipeline'">
             <!-- Seletor de Produto -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-semibold text-slate-200">Esteira do Produto:</h2>
                    <select v-model="selectedProduct" class="form-select text-lg bg-[#2D2D2D] border-[#4a4a4a] rounded-md">
                        <option v-for="product in products" :key="product.id" :value="product">
                            {{ product.name }}
                        </option>
                    </select>
                </div>
                <button @click="addProduct" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-sky-700 transition-colors flex items-center gap-2 mt-4 sm:mt-0">
                    <i class="fa-solid fa-plus"></i> Novo Produto
                </button>
            </div>

            <!-- Etapas do Produto Selecionado -->
            <div v-if="selectedProduct">
                <div class="flex justify-between items-center mb-4 mt-8">
                    <h3 class="text-lg font-semibold text-slate-300">Etapas para {{ selectedProduct.name }}</h3>
                    <button @click="addStage" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-600 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Nova Etapa
                    </button>
                </div>
                <div class="space-y-4">
                    <div v-for="(stage, index) in selectedProduct.stages" :key="stage.id" class="bg-[#2D2D2D] p-4 rounded-lg flex flex-col sm:flex-row sm:items-center gap-4">
                        <div class="flex-grow w-full">
                            <label class="text-sm font-medium text-slate-300">Título da Etapa</label>
                            <input type="text" v-model="stage.title" class="form-input w-full mt-1 rounded-md text-sm py-3"/>
                        </div>
                        <div class="w-full sm:w-auto">
                            <label class="text-sm font-medium text-slate-300">Prazo (SLA em dias)</label>
                            <input type="number" v-model="stage.slaDays" class="form-input w-full sm:w-28 mt-1 rounded-md text-sm py-3"/>
                        </div>
                        <div class="flex items-center gap-4 self-end sm:self-auto">
                            <button @click="openStageFieldsModal(stage)" class="text-slate-200 hover:text-white transition-colors" title="Configurar Campos"><i class="fa-solid fa-cogs fa-lg"></i></button>
                            <button @click="removeStage(index)" class="text-red-500 hover:text-red-400 transition-colors" title="Remover Etapa"><i class="fa-solid fa-trash-can fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            </div>
          </div>

          <!-- Notificações e Integrações -->
          <div v-if="activeTab === 'notifications'">
            <h2 class="text-xl font-semibold text-slate-200 mb-4">Permissões de Notificação</h2>
            <div class="bg-[#2D2D2D] rounded-lg overflow-x-auto mb-8">
              <table class="w-full text-sm text-left">
                <thead class="bg-[#3E3E3E]/60 text-xs text-slate-300 uppercase">
                  <tr>
                    <th class="px-6 py-3">Nível de Acesso</th>
                    <th v-for="type in notificationTypes" :key="type" class="px-6 py-3 text-center">
                      {{ type }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="level in accessLevels"
                    :key="level"
                    class="border-b border-[#3E3E3E]"
                  >
                    <td class="px-6 py-4 font-medium text-slate-100">{{ level }}</td>
                    <td
                      v-for="type in notificationTypes"
                      :key="type"
                      class="px-6 py-4 text-center"
                    >
                      <input
                        type="checkbox"
                        v-model="notificationSettings[level][type]"
                        class="form-checkbox h-5 w-5 rounded"
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold text-slate-200">Configuração de Integrações</h2>
              <button
                @click="addIntegration"
                class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-600 transition-colors flex items-center gap-2"
              >
                <i class="fa-solid fa-plus"></i> Nova Integração
              </button>
            </div>
            <div class="bg-[#2D2D2D] p-6 rounded-lg space-y-4">
              <div
                v-for="(integration, index) in integrations"
                :key="index"
                class="bg-[#3E3E3E] p-4 rounded-lg space-y-3"
              >
                <div class="flex justify-between items-center">
                  <input
                    type="text"
                    v-model="integration.name"
                    placeholder="Nome da Integração (Ex: WhatsApp)"
                    class="form-input bg-transparent border-0 text-lg font-semibold text-slate-100 focus:ring-0 p-0"
                  />
                  <button @click="removeIntegration(index)" class="text-red-500 hover:text-red-400">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium">Tipo de Credencial</label>
                    <select v-model="integration.type" class="form-select w-full mt-1 text-sm">
                      <option value="api_key">API Key</option>
                      <option value="endpoint">Endpoint</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-medium">{{
                      integration.type === 'api_key' ? 'API Key' : 'URL do Endpoint'
                    }}</label>
                    <input
                      type="text"
                      v-model="integration.value"
                      class="form-input w-full mt-1 text-sm"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Botão Flutuante de Comunicação -->
      <button @click="isCommunicationPanelOpen = !isCommunicationPanelOpen" class="fixed bottom-6 right-6 bg-orange-500 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-orange-600 transition-transform transform hover:scale-110 z-50 relative">
          <i class="fa-solid fa-envelope fa-lg"></i>
          <span v-if="unreadCount > 0" class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-[#1c1c1c] transform translate-x-1/4 -translate-y-1/4">
              {{ unreadCount }}
          </span>
      </button>


      <!-- Painel de Comunicação -->
      <aside
        v-if="isCommunicationPanelOpen"
        :style="{ top: panelPosition.y + 'px', left: panelPosition.x + 'px' }"
        class="fixed w-full max-w-sm bg-[#2D2D2D] border border-[#4a4a4a] shadow-2xl z-40 flex flex-col rounded-lg"
      >
        <header @mousedown="dragMouseDown" class="p-4 border-b border-[#4a4a4a] flex justify-between items-center cursor-move">
          <h2 class="text-xl font-bold text-slate-100">Notificações</h2>
          <button
            @click="isCommunicationPanelOpen = false"
            class="text-slate-500 hover:text-slate-300"
          >
            <i class="fa-solid fa-xmark fa-lg"></i>
          </button>
        </header>

        <div class="overflow-y-auto flex-grow p-4 space-y-3 max-h-[60vh]">
          <div
            v-for="n in 5"
            :key="n"
            class="flex items-start gap-3 p-3 rounded-lg hover:bg-[#3E3E3E]/50 cursor-pointer"
          >
            <div
              class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center flex-shrink-0 mt-1"
            >
              <i class="fa-solid fa-file-invoice text-orange-400"></i>
            </div>
            <div>
              <p class="text-sm font-semibold text-slate-200">Nova proposta recebida</p>
              <p class="text-xs text-slate-400">
                Proposta #1234{{n}} de Ana Clara Souza foi adicionada à esteira.
              </p>
              <p class="text-xs text-slate-500 mt-1">{{ n * 2 }} min atrás</p>
            </div>
          </div>
        </div>
      </aside>

      <!-- Modal de Usuário -->
      <div
        v-if="isUserModalOpen"
        class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4"
      >
        <div
          class="bg-[#2D2D2D] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col"
        >
          <header class="p-6 border-b border-[#3E3E3E] flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-100">
              {{ currentUser.id ? 'Editar' : 'Novo' }} Usuário
            </h2>
            <button
              @click="isUserModalOpen = false"
              class="text-slate-500 hover:text-slate-300"
            >
              <i class="fa-solid fa-xmark fa-2x"></i>
            </button>
          </header>
          <main class="p-6 overflow-y-auto flex-grow space-y-6">
            <!-- Abas do Modal de Usuário -->
            <div class="mb-4 border-b border-gray-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button @click="userModalTab = 'personal'" :class="userModalTab === 'personal' ? 'tab-active' : 'border-transparent text-gray-400 hover:text-gray-200'">Dados</button>
                    <button @click="userModalTab = 'documents'" :class="userModalTab === 'documents' ? 'tab-active' : 'border-transparent text-gray-400 hover:text-gray-200'">Documentos</button>
                    <button v-if="canManageUsers(currentUser.accessLevel)" @click="userModalTab = 'hierarchy'" :class="userModalTab === 'hierarchy' ? 'tab-active' : 'border-transparent text-gray-400 hover:text-gray-200'">Hierarquia</button>
                </nav>
            </div>

            <!-- Conteúdo da Aba: Dados Pessoais e Empresa -->
            <div v-if="userModalTab === 'personal'">
                <h3 class="text-lg font-semibold text-slate-200 border-b border-gray-700 pb-2">Dados Pessoais</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div><label class="block text-sm font-medium">Nome</label><input type="text" v-model="currentUser.name" class="form-input w-full mt-1" /></div>
                    <div><label class="block text-sm font-medium">E-mail</label><input type="email" v-model="currentUser.email" class="form-input w-full mt-1" /></div>
                </div>
                <h3 class="text-lg font-semibold text-slate-200 border-b border-gray-700 pb-2 mt-6">Dados da Empresa</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div><label class="block text-sm font-medium">Nome da Empresa</label><input type="text" v-model="currentUser.companyName" class="form-input w-full mt-1" /></div>
                    <div><label class="block text-sm font-medium">CNPJ</label><input type="text" v-model="currentUser.cnpj" class="form-input w-full mt-1" /></div>
                </div>
                <h3 class="text-lg font-semibold text-slate-200 border-b border-gray-700 pb-2 mt-6">Acesso</h3>
                <div class="mt-4">
                    <label class="block text-sm font-medium">Nível de Acesso</label>
                    <select v-model="currentUser.accessLevel" class="form-select w-full mt-1">
                        <option v-for="level in accessLevels" :key="level" :value="level">{{ level }}</option>
                    </select>
                </div>
            </div>

            <!-- Conteúdo da Aba: Documentos -->
            <div v-if="userModalTab === 'documents'">
                <h3 class="text-lg font-semibold text-slate-200 border-b border-gray-700 pb-2 mb-4">Documentos do Usuário e Sócios</h3>
                <div class="space-y-4">
                    <div v-for="(doc, index) in currentUser.documents" :key="index" class="bg-[#3E3E3E] p-3 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-slate-100">{{ doc.type }} - {{ doc.owner }}</p>
                            <p class="text-xs text-slate-400 mt-1"><i class="fa-solid fa-file mr-2"></i>{{ doc.fileName }}</p>
                        </div>
                        <button @click="removeDocument(index)" class="text-red-500 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="bg-[#3E3E3E] p-4 rounded-lg space-y-3">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium">Tipo de Documento</label><input type="text" v-model="newDocument.type" placeholder="Ex: Contrato Social" class="form-input w-full mt-1 text-sm"/></div>
                            <div><label class="text-sm font-medium">Proprietário</label><input type="text" v-model="newDocument.owner" placeholder="Nome do Sócio ou 'Principal'" class="form-input w-full mt-1 text-sm"/></div>
                        </div>
                        <div class="flex items-center gap-4 pt-2">
                            <input type="file" ref="fileInput" @change="handleFileChange" class="hidden"/>
                            <button @click="fileInput.click()" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm flex-shrink-0"><i class="fa-solid fa-upload mr-2"></i> Escolher Arquivo</button>
                            <span class="text-sm text-slate-400 truncate">{{ newDocument.fileName || 'Nenhum arquivo selecionado' }}</span>
                        </div>
                        <button @click="addDocument" class="w-full mt-3 bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">Adicionar Documento</button>
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba: Hierarquia -->
            <div v-if="userModalTab === 'hierarchy'">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-200">Usuários Gerenciados</h3>
                    <button class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Adicionar Usuário</button>
                </div>
                <p class="text-slate-400 text-sm">Aqui será exibida a lista de usuários que <strong class="text-slate-200">{{ currentUser.name }}</strong> pode gerenciar.</p>
                <!-- A tabela de usuários gerenciados seria inserida aqui -->
            </div>
          </main>
          <footer class="p-6 bg-[#2D2D2D]/80 border-t border-[#3E3E3E] flex justify-end gap-4">
            <button @click="isUserModalOpen = false" class="bg-[#3E3E3E] text-slate-200 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
            <button @click="saveUser" class="bg-orange-500 text-white font-semibold py-2 px-5 rounded-lg">Salvar</button>
          </footer>
        </div>
      </div>

      <!-- Modal de Campos da Etapa -->
      <div v-if="isStageFieldsModalOpen" class="fixed inset-0 bg-black/70 z-50 flex justify-center items-center p-4">
        <div class="bg-[#2D2D2D] rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
          <header class="p-6 border-b border-[#3E3E3E] flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-100">Configurar Campos: {{ currentStageForFields.title }}</h2>
            <button @click="isStageFieldsModalOpen = false" class="text-slate-500 hover:text-slate-300"><i class="fa-solid fa-xmark fa-2x"></i></button>
          </header>
          <main class="p-6 overflow-y-auto flex-grow space-y-4">
            <div v-for="(field, index) in currentStageForFields.fields" :key="index" class="bg-[#3E3E3E] p-4 rounded-lg space-y-3">
              <div class="flex justify-between items-center">
                <h4 class="font-semibold">Campo {{ index + 1 }}</h4>
                <button @click="removeField(index)" class="text-red-500 hover:text-red-400"><i class="fa-solid fa-trash-can"></i></button>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div><label class="text-sm font-medium">Rótulo (Label)</label><input type="text" v-model="field.label" class="form-input w-full mt-1 text-sm" placeholder="Ex: Valor do Imóvel"/></div>
                <div>
                  <label class="text-sm font-medium">Tipo de Input</label>
                  <select v-model="field.type" class="form-select w-full mt-1 text-sm">
                    <option value="text">Texto Curto</option>
                    <option value="textarea">Texto Longo</option>
                    <option value="number">Número</option>
                    <option value="date">Data</option>
                    <option value="select">Seleção (Dropdown)</option>
                    <option value="checkbox">Caixa de Seleção</option>
                    <option value="file">Upload de Arquivo</option>
                  </select>
                </div>
              </div>
              <div v-if="field.type === 'select'"><label class="text-sm font-medium">Opções (uma por linha)</label><textarea v-model="field.options" class="form-textarea w-full mt-1 text-sm" rows="3"></textarea></div>
              <div><label class="flex items-center"><input type="checkbox" v-model="field.required" class="form-checkbox" /><span class="ml-2 text-sm">Obrigatório</span></label></div>
            </div>
            <button @click="addField" class="w-full bg-orange-500/20 text-orange-400 border-2 border-dashed border-orange-500/30 hover:bg-orange-500/30 font-semibold py-3 px-4 rounded-lg transition-colors"><i class="fa-solid fa-plus mr-2"></i> Adicionar Campo</button>
          </main>
          <footer class="p-6 bg-[#2D2D2D]/80 border-t border-[#3E3E3E] flex justify-end gap-4">
            <button @click="isStageFieldsModalOpen = false" class="bg-orange-500 text-white font-semibold py-2 px-5 rounded-lg">Fechar</button>
          </footer>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted, onUnmounted } = Vue;

      createApp({
        setup() {
          const activeTab = ref('users');
          const users = ref([
            { id: 1, name: 'Admin Geral', email: 'admin@plataforma.com', companyName: 'Plataforma Corp', cnpj: '00.000.000/0001-00', accessLevel: 'Admin', isActive: true, documents: [], managedUsers: [] },
            { id: 2, name: 'Carlos Lima', email: 'carlos@plataforma.com', companyName: 'Representações XP', cnpj: '11.111.111/0001-11', accessLevel: 'Representante', isActive: true, documents: [], managedUsers: [] },
          ]);
          const isUserModalOpen = ref(false);
          const userModalTab = ref('personal');
          const currentUser = ref({});
          const newDocument = ref({ type: '', owner: '', fileName: null });
          const fileInput = ref(null);
          const accessLevels = ref(['Admin', 'Gestor', 'Fundo', 'Representante', 'Diretoria', 'Fornecedor']);
          const products = ref([
            {
                id: 1,
                name: 'ConsorEquity',
                stages: [
                    { id: 101, title: 'Dados Básicos', slaDays: 2, fields: [{ label: 'Nome Completo', type: 'text', required: true }, { label: 'CPF', type: 'text', required: true }, { label: 'Valor do Crédito', type: 'number', required: true }] },
                    { id: 102, title: 'Documentação', slaDays: 5, fields: [{ label: 'Comprovante de Renda', type: 'file', required: true }] },
                ]
            },
            {
                id: 2,
                name: 'Consorbiud',
                stages: [
                    { id: 201, title: 'Análise Inicial', slaDays: 3, fields: [] },
                    { id: 202, title: 'Envio de Proposta', slaDays: 2, fields: [] },
                ]
            }
          ]);
          const selectedProduct = ref(products.value[0]);
          const isStageFieldsModalOpen = ref(false);
          const currentStageForFields = ref(null);
          const notificationTypes = ref(['E-mail', 'Push', 'WebSocket', 'WhatsApp']);
          const notificationSettings = ref(
            accessLevels.value.reduce((acc, level) => {
              acc[level] = { 'E-mail': true, Push: false, WebSocket: false, WhatsApp: false };
              return acc;
            }, {}),
          );
          const integrations = ref([
              { name: 'WhatsApp', type: 'api_key', value: '' },
              { name: 'WebSocket', type: 'endpoint', value: '' }
          ]);
          
          const isCommunicationPanelOpen = ref(false);
          const unreadCount = ref(5);
          
          const isDragging = ref(false);
          const panelPosition = ref({ x: window.innerWidth - 400, y: 20 });
          const dragStart = ref({ x: 0, y: 0 });

          const canManageUsers = (level) => ['Admin', 'Gestor', 'Fundo', 'Representante'].includes(level);

          const openUserModal = (user = null) => {
            userModalTab.value = 'personal';
            currentUser.value = user
              ? JSON.parse(JSON.stringify(user))
              : { name: '', email: '', companyName: '', cnpj: '', accessLevel: 'Representante', isActive: true, documents: [], managedUsers: [] };
            isUserModalOpen.value = true;
          };

          const saveUser = () => {
            if (currentUser.value.id) {
              const index = users.value.findIndex((u) => u.id === currentUser.value.id);
              if (index !== -1) users.value[index] = currentUser.value;
            } else {
              currentUser.value.id = Date.now();
              users.value.push(currentUser.value);
            }
            isUserModalOpen.value = false;
          };
          
          const handleFileChange = (event) => {
              const file = event.target.files[0];
              if (file) {
                  newDocument.value.fileName = file.name;
              }
          };

          const addDocument = () => {
              if(!newDocument.value.type || !newDocument.value.owner || !newDocument.value.fileName) {
                  alert('Por favor, preencha todos os campos e selecione um arquivo.');
                  return;
              };
              if(!currentUser.value.documents) currentUser.value.documents = [];
              currentUser.value.documents.push({...newDocument.value});
              newDocument.value = { type: '', owner: '', fileName: null };
              if(fileInput.value) fileInput.value.value = '';
          };
          
          const removeDocument = (index) => {
              currentUser.value.documents.splice(index, 1);
          };
          
          const addProduct = () => {
            const newName = prompt("Digite o nome do novo produto:");
            if (newName) {
                const newProduct = {
                    id: Date.now(),
                    name: newName,
                    stages: []
                };
                products.value.push(newProduct);
                selectedProduct.value = newProduct;
            }
          };

          const addStage = () => {
            if (selectedProduct.value) {
                selectedProduct.value.stages.push({
                    id: Date.now(),
                    title: 'Nova Etapa',
                    slaDays: 3,
                    fields: [],
                });
            }
          };

          const removeStage = (index) => {
            if (selectedProduct.value) {
                selectedProduct.value.stages.splice(index, 1);
            }
          };

          const openStageFieldsModal = (stage) => {
            currentStageForFields.value = stage;
            isStageFieldsModalOpen.value = true;
          };

          const addField = () => {
            currentStageForFields.value.fields.push({ label: '', type: 'text', required: false, options: '' });
          };

          const removeField = (index) => {
            currentStageForFields.value.fields.splice(index, 1);
          };
          
          const addIntegration = () => {
              integrations.value.push({ name: '', type: 'api_key', value: '' });
          };

          const removeIntegration = (index) => {
              integrations.value.splice(index, 1);
          };
          
          const dragMouseDown = (event) => {
              event.preventDefault();
              isDragging.value = true;
              dragStart.value.x = event.clientX - panelPosition.value.x;
              dragStart.value.y = event.clientY - panelPosition.value.y;
              document.addEventListener('mousemove', mouseMove);
              document.addEventListener('mouseup', mouseUp);
          };

          const mouseMove = (event) => {
              if (!isDragging.value) return;
              panelPosition.value.x = event.clientX - dragStart.value.x;
              panelPosition.value.y = event.clientY - dragStart.value.y;
          };

          const mouseUp = () => {
              isDragging.value = false;
              document.removeEventListener('mousemove', mouseMove);
              document.removeEventListener('mouseup', mouseUp);
          };

          onUnmounted(() => {
              document.removeEventListener('mousemove', mouseMove);
              document.removeEventListener('mouseup', mouseUp);
          });

          return {
            activeTab, users, isUserModalOpen, userModalTab, currentUser, accessLevels, openUserModal, saveUser,
            products, selectedProduct, addProduct, addStage, removeStage, isStageFieldsModalOpen, currentStageForFields, openStageFieldsModal,
            addField, removeField, notificationTypes, notificationSettings, canManageUsers, newDocument, addDocument, removeDocument,
            fileInput, handleFileChange, integrations, addIntegration, removeIntegration,
            isCommunicationPanelOpen, unreadCount, panelPosition, dragMouseDown
          };
        },
      }).mount('#admin-app');
    </script>
  </body>
</html>
